<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Adding Correspondences Using Constraints &#8212; AutoCNet</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Creating a Control Network" href="9. Creating a Control Network.html" />
    <link rel="prev" title="Saving and Loading" href="7. Saving and Loading.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/favicon.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">AutoCNet</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=USGS-Astrogeology&repo=plio&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html">What is AutoCNet?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html">Installing AutoCNet</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Getting Started with AutoCNet</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="1. Creating the CandidateGraph Object.html"> Creating the CandidateGraph Object</a></li>
<li class="toctree-l3"><a class="reference internal" href="2. Extracting Keypoints (Interest Points).html"> Extracting Keypoints (Interest Points)</a></li>
<li class="toctree-l3"><a class="reference internal" href="3. Matching.html"> Matching</a></li>
<li class="toctree-l3"><a class="reference internal" href="4. Fundamental Matrix.html"> Fundamental Matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="5a. Coupled Decomposition - Part I.html"> Coupled Decomposition - Part I</a></li>
<li class="toctree-l3"><a class="reference internal" href="5b. Coupled Decomposition - Part II.html"> Coupled Decomposition - Part II</a></li>
<li class="toctree-l3"><a class="reference internal" href="5c. Coupled Decomposition - Part III.html"> Coupled Decomposition - Part III</a></li>
<li class="toctree-l3"><a class="reference internal" href="6a. Subpixel Matching - Part I.html"> Subpixel Matching - Part I</a></li>
<li class="toctree-l3"><a class="reference internal" href="6b. Subpixel Matching - Part II.html"> Subpixel Matching - Part II</a></li>
<li class="toctree-l3"><a class="reference internal" href="7. Saving and Loading.html"> Saving and Loadin</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"> Adding Correspondences Using Constraints</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Create-the-CandidateGraph">Create the CandidateGraph</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Fundamental-Matrix">Fundamental Matrix</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Option-1:">Option 1:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="9. Creating a Control Network.html"> Creating a Control Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="Advanced 1. Extending the CandidateGraph.html"> Advanced: Extending the CandidateGraph</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../library/index.html">Library Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">User Guide</a><ul>
  <li><a href="../index.html">Getting Started with AutoCNet</a><ul>
      <li>Previous: <a href="7. Saving and Loading.html" title="previous chapter">Saving and Loading</a></li>
      <li>Next: <a href="9. Creating a Control Network.html" title="next chapter">Creating a Control Network</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style>
<div class="section" id="Adding-Correspondences-Using-Constraints">
<h1>Adding Correspondences Using Constraints<a class="headerlink" href="#Adding-Correspondences-Using-Constraints" title="Permalink to this headline">¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;/data/autocnet&#39;</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">autocnet</span>
<span class="c1"># Enable the GPU</span>
<span class="n">autocnet</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">autocnet</span> <span class="k">import</span> <span class="n">CandidateGraph</span>

<span class="c1"># The GPU based extraction library that contains SIFT extraction and matching</span>
<span class="kn">import</span> <span class="nn">cudasift</span> <span class="k">as</span> <span class="nn">cs</span>
<span class="c1"># A method to resize the images on the fly.</span>
<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="k">import</span> <span class="n">imresize</span>

<span class="o">%</span><span class="k">pylab</span> inline
<span class="n">figsize</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Populating the interactive namespace from numpy and matplotlib
</pre></div></div>
</div>
<div class="section" id="Create-the-CandidateGraph">
<h2>Create the CandidateGraph<a class="headerlink" href="#Create-the-CandidateGraph" title="Permalink to this headline">¶</a></h2>
<p>Just like the other notebooks this cell creates the candidate graph.
This also patches in functionality to the object on the fly. To get a
handle on what is going on, checkout the <a class="reference internal" href="Advanced 1. Extending the CandidateGraph.html"><span class="doc">Advanced 1. Extending the
CandidateGraph</span></a>
notebook.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Create the candidate graph and enable a GPU</span>
<span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;AS15-P-0111_CENTER_LRG_CROPPED.png&#39;</span>
<span class="n">b</span> <span class="o">=</span> <span class="s1">&#39;AS15-P-0112_CENTER_LRG_CROPPED.png&#39;</span>

<span class="n">adj</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:[</span><span class="n">b</span><span class="p">],</span>
       <span class="n">b</span><span class="p">:[</span><span class="n">a</span><span class="p">]}</span>

<span class="n">cg</span> <span class="o">=</span> <span class="n">CandidateGraph</span><span class="o">.</span><span class="n">from_adjacency</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>

<span class="c1"># Define a function to do the feature extraction.</span>
<span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">downsample_amount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">total_size</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">downsample_amount</span><span class="p">:</span>
        <span class="n">downsample_amount</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_size</span> <span class="o">/</span> <span class="mi">12500</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">downsample_amount</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">downsample_amount</span><span class="p">))</span>
    <span class="c1"># Downsample</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">imresize</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;lanczos&#39;</span><span class="p">)</span>

    <span class="n">npts</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.5</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">PySiftData</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
    <span class="n">cs</span><span class="o">.</span><span class="n">ExtractKeypoints</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">kp</span><span class="p">,</span> <span class="n">des</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">to_data_frame</span><span class="p">()</span>
    <span class="n">kp</span> <span class="o">=</span> <span class="n">kp</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;sharpness&#39;</span><span class="p">,</span> <span class="s1">&#39;edgeness&#39;</span><span class="p">,</span> <span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;ambiguity&#39;</span><span class="p">]]</span>
    <span class="n">kp</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">kp</span><span class="p">[</span><span class="s1">&#39;ambiguity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Match the interface defined in the edge.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keypoints</span> <span class="o">=</span> <span class="n">kp</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="n">des</span>

    <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;downsample_amount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">downsample_amount</span>

<span class="c1"># Import the class and update it.  This updates the current instance of the CandidateGraph</span>
<span class="kn">from</span> <span class="nn">autocnet.graph.node</span> <span class="k">import</span> <span class="n">Node</span>
<span class="n">Node</span><span class="o">.</span><span class="n">extract_features</span> <span class="o">=</span> <span class="n">extract_features</span>

<span class="c1"># Extract the features</span>
<span class="n">cg</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Match</span>
<span class="n">cg</span><span class="o">.</span><span class="n">match</span><span class="p">()</span>

<span class="c1"># Apply outlier detection - see the above linked notebook if you are curious about what is going on here.</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">e</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">ambiguity</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">ambiguity</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.015</span><span class="p">)</span>
    <span class="n">e</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;=</span> <span class="n">e</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.85</span><span class="p">)</span>

<span class="c1"># Compute the F Matrix</span>
<span class="n">cg</span><span class="o">.</span><span class="n">compute_fundamental_matrices</span><span class="p">(</span><span class="n">clean_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">clean_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fundamental&#39;</span><span class="p">],</span> <span class="n">line_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="mf">0.35</span><span class="p">},</span> <span class="n">downsampling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[5]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f77ed4afcf8&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/users_tutorials_apollopan_8._Adding_Correspondences_Using_Constraints_4_1.png" src="../../../_images/users_tutorials_apollopan_8._Adding_Correspondences_Using_Constraints_4_1.png" />
</div>
</div>
</div>
<div class="section" id="Fundamental-Matrix">
<h2>Fundamental Matrix<a class="headerlink" href="#Fundamental-Matrix" title="Permalink to this headline">¶</a></h2>
<p>Since the fundamental matrix provides the reprojection from a point in
one image to an epipolar line in another image, it is possible to
utilize a &#8216;good&#8217; fundamental matrix to introduce new correspondences
into the solution. We demonstrate this below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">cg</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsampling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">cg</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">downsampling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/users_tutorials_apollopan_8._Adding_Correspondences_Using_Constraints_6_0.png" src="../../../_images/users_tutorials_apollopan_8._Adding_Correspondences_Using_Constraints_6_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[6]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f77ec119128&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/users_tutorials_apollopan_8._Adding_Correspondences_Using_Constraints_6_2.png" src="../../../_images/users_tutorials_apollopan_8._Adding_Correspondences_Using_Constraints_6_2.png" />
</div>
</div>
<p>The large black swatch beginning approximately 1/3 of the way from the
lower left hand corner of the upper image has correspondences that not
being matched into the lower image. Here, we will try to match some of
those.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">e</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

<span class="n">kps</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keypoints</span>
<span class="n">search_points</span> <span class="o">=</span> <span class="n">kps</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;x &gt; 3500 and y &gt; 1900&#39;</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">search_points</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[10]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>107
</pre></div>
</div>
</div>
<p>The first approach is to see which, if any, of the correspondences have
been rejected due to the automated application of the ratio and score
tests.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">candidates</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">source_idx</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_points</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
<span class="n">candidates</span><span class="p">[[</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;ambiguity&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>score</th>
      <th>ambiguity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>107.000000</td>
      <td>107.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.909333</td>
      <td>0.977450</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.047493</td>
      <td>0.028953</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.769302</td>
      <td>0.865864</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>0.883995</td>
      <td>0.974207</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.913909</td>
      <td>0.987876</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.941907</td>
      <td>0.995622</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.993631</td>
      <td>0.999759</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">good_candidates</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;ambiguity &lt;= 0.92 and score &gt;= 0.8&#39;</span><span class="p">)</span>
<span class="n">good_candidates</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>source_image</th>
      <th>source_idx</th>
      <th>destination_image</th>
      <th>destination_idx</th>
      <th>score</th>
      <th>ambiguity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1231</th>
      <td>0.0</td>
      <td>1231</td>
      <td>1.0</td>
      <td>289</td>
      <td>0.985849</td>
      <td>0.865864</td>
    </tr>
    <tr>
      <th>1240</th>
      <td>0.0</td>
      <td>1240</td>
      <td>1.0</td>
      <td>319</td>
      <td>0.964188</td>
      <td>0.902102</td>
    </tr>
    <tr>
      <th>1244</th>
      <td>0.0</td>
      <td>1244</td>
      <td>1.0</td>
      <td>298</td>
      <td>0.958613</td>
      <td>0.906215</td>
    </tr>
    <tr>
      <th>1251</th>
      <td>0.0</td>
      <td>1251</td>
      <td>1.0</td>
      <td>394</td>
      <td>0.984362</td>
      <td>0.873866</td>
    </tr>
    <tr>
      <th>1277</th>
      <td>0.0</td>
      <td>1277</td>
      <td>1.0</td>
      <td>343</td>
      <td>0.966390</td>
      <td>0.917908</td>
    </tr>
    <tr>
      <th>1285</th>
      <td>0.0</td>
      <td>1285</td>
      <td>1.0</td>
      <td>341</td>
      <td>0.971325</td>
      <td>0.918181</td>
    </tr>
    <tr>
      <th>1286</th>
      <td>0.0</td>
      <td>1286</td>
      <td>1.0</td>
      <td>339</td>
      <td>0.913909</td>
      <td>0.919853</td>
    </tr>
    <tr>
      <th>1299</th>
      <td>0.0</td>
      <td>1299</td>
      <td>1.0</td>
      <td>7</td>
      <td>0.889101</td>
      <td>0.871516</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Now use the fundamental matrix to check the reprojective errors of these
points.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">kp1</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">get_keypoint_coordinates</span><span class="p">(</span><span class="n">good_candidates</span><span class="o">.</span><span class="n">source_idx</span><span class="p">)</span>
<span class="n">kp2</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">destination</span><span class="o">.</span><span class="n">get_keypoint_coordinates</span><span class="p">(</span><span class="n">good_candidates</span><span class="o">.</span><span class="n">destination_idx</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">autocnet.transformation</span> <span class="k">import</span> <span class="n">fundamental_matrix</span> <span class="k">as</span> <span class="n">fm</span>

<span class="n">F</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;fundamental_matrix&#39;</span><span class="p">]</span>
<span class="n">reproj_error</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">compute_reprojection_error</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">kp2</span><span class="p">)</span>
<span class="n">reproj_error</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[22]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>289       0.574755
319       1.291168
298       0.504600
394       7.831943
343       1.133071
341       0.382119
339       2.519372
7      3294.844107
dtype: float64
</pre></div>
</div>
</div>
<p>All but three of the correspondences above look to meet the reprojection
error constraint. This suggests that many more correspondences might
have been rejected from our automated methods than needed to be. It is
possible to address this in two ways:</p>
</div>
<div class="section" id="Option-1:">
<h2>Option 1:<a class="headerlink" href="#Option-1:" title="Permalink to this headline">¶</a></h2>
<p>Add good correspondences in the region to a custom mask.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Create a new mask</span>
<span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="s1">&#39;custom_fundamental&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="s1">&#39;fundamental&#39;</span><span class="p">]</span>

<span class="c1"># grab the reprojected coordinates with okay error</span>
<span class="n">reproj</span> <span class="o">=</span> <span class="n">reproj_error</span><span class="p">[</span><span class="n">reproj_error</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">source_idx</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">reproj</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
<span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="s1">&#39;custom_fundamental&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">idx</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>source_image</th>
      <th>source_idx</th>
      <th>destination_image</th>
      <th>destination_idx</th>
      <th>score</th>
      <th>ambiguity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>289</th>
      <td>0.0</td>
      <td>289</td>
      <td>1.0</td>
      <td>133</td>
      <td>0.921849</td>
      <td>0.998795</td>
    </tr>
    <tr>
      <th>298</th>
      <td>0.0</td>
      <td>298</td>
      <td>1.0</td>
      <td>183</td>
      <td>0.855483</td>
      <td>0.988294</td>
    </tr>
    <tr>
      <th>319</th>
      <td>0.0</td>
      <td>319</td>
      <td>1.0</td>
      <td>2804</td>
      <td>0.882774</td>
      <td>0.960796</td>
    </tr>
    <tr>
      <th>341</th>
      <td>0.0</td>
      <td>341</td>
      <td>1.0</td>
      <td>3170</td>
      <td>0.924507</td>
      <td>0.884061</td>
    </tr>
    <tr>
      <th>343</th>
      <td>0.0</td>
      <td>343</td>
      <td>1.0</td>
      <td>242</td>
      <td>0.991612</td>
      <td>0.998301</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">clean_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;custom_fundamental&#39;</span><span class="p">],</span> <span class="n">downsampling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">line_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="mf">0.35</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[32]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f77e461a588&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/users_tutorials_apollopan_8._Adding_Correspondences_Using_Constraints_16_1.png" src="../../../_images/users_tutorials_apollopan_8._Adding_Correspondences_Using_Constraints_16_1.png" />
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2015 - , AutoCNetDevelopers.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../../../_sources/users/tutorials/apollopan/8. Adding Correspondences Using Constraints.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>