<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Coupled Decomposition - Part I &#8212; AutoCNet</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Coupled Decomposition - Part II" href="5b. Coupled Decomposition - Part II.html" />
    <link rel="prev" title="Fundamental Matrix" href="4. Fundamental Matrix.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/favicon.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">AutoCNet</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=USGS-Astrogeology&repo=plio&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html">What is AutoCNet?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html">Installing AutoCNet</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Getting Started with AutoCNet</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="1. Creating the CandidateGraph Object.html"> Creating the CandidateGraph Object</a></li>
<li class="toctree-l3"><a class="reference internal" href="2. Extracting Keypoints (Interest Points).html"> Extracting Keypoints (Interest Points)</a></li>
<li class="toctree-l3"><a class="reference internal" href="3. Matching.html"> Matching</a></li>
<li class="toctree-l3"><a class="reference internal" href="4. Fundamental Matrix.html"> Fundamental Matrix</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"> Coupled Decomposition - Part I</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#CandidateGraph--&gt;-Custom-Extraction-Func--&gt;-Matching--&gt;-Coupled-Decomposition">CandidateGraph -&gt; Custom Extraction Func -&gt; Matching -&gt; Coupled Decomposition</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Coupled-Decomposition">Coupled Decomposition</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Failure-&amp;-Solution">Failure &amp; Solution</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="5b. Coupled Decomposition - Part II.html"> Coupled Decomposition - Part II</a></li>
<li class="toctree-l3"><a class="reference internal" href="5c. Coupled Decomposition - Part III.html"> Coupled Decomposition - Part III</a></li>
<li class="toctree-l3"><a class="reference internal" href="6a. Subpixel Matching - Part I.html"> Subpixel Matching - Part I</a></li>
<li class="toctree-l3"><a class="reference internal" href="6b. Subpixel Matching - Part II.html"> Subpixel Matching - Part II</a></li>
<li class="toctree-l3"><a class="reference internal" href="7. Saving and Loading.html"> Saving and Loadin</a></li>
<li class="toctree-l3"><a class="reference internal" href="8. Adding Correspondences Using Constraints.html"> Adding Correspondences Using Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="9. Creating a Control Network.html"> Creating a Control Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="Advanced 1. Extending the CandidateGraph.html"> Advanced: Extending the CandidateGraph</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../library/index.html">Library Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">User Guide</a><ul>
  <li><a href="../index.html">Getting Started with AutoCNet</a><ul>
      <li>Previous: <a href="4. Fundamental Matrix.html" title="previous chapter">Fundamental Matrix</a></li>
      <li>Next: <a href="5b. Coupled Decomposition - Part II.html" title="next chapter">Coupled Decomposition - Part II</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style>
<div class="section" id="Coupled-Decomposition---Part-I">
<h1>Coupled Decomposition - Part I<a class="headerlink" href="#Coupled-Decomposition---Part-I" title="Permalink to this headline">¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;/data/autocnet&#39;</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">autocnet</span>
<span class="kn">from</span> <span class="nn">autocnet</span> <span class="k">import</span> <span class="n">CandidateGraph</span>

<span class="c1"># The GPU based extraction library that contains SIFT extraction and matching</span>
<span class="kn">import</span> <span class="nn">cudasift</span> <span class="k">as</span> <span class="nn">cs</span>

<span class="c1"># A method to resize the images on the fly.</span>
<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="k">import</span> <span class="n">imresize</span>

<span class="c1"># Fundamental matrix computation</span>
<span class="kn">from</span> <span class="nn">autocnet.transformation</span> <span class="k">import</span> <span class="n">fundamental_matrix</span> <span class="k">as</span> <span class="n">fm</span>

<span class="o">%</span><span class="k">pylab</span> inline
<span class="n">figsize</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Populating the interactive namespace from numpy and matplotlib
</pre></div></div>
</div>
<div class="section" id="CandidateGraph--&gt;-Custom-Extraction-Func--&gt;-Matching--&gt;-Coupled-Decomposition">
<h2>CandidateGraph -&gt; Custom Extraction Func -&gt; Matching -&gt; Coupled Decomposition<a class="headerlink" href="#CandidateGraph-->-Custom-Extraction-Func-->-Matching-->-Coupled-Decomposition" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;AS15-P-0111_CENTER_LRG_CROPPED.png&#39;</span>
<span class="n">b</span> <span class="o">=</span> <span class="s1">&#39;AS15-P-0112_CENTER_LRG_CROPPED.png&#39;</span>

<span class="n">adj</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:[</span><span class="n">b</span><span class="p">],</span>
       <span class="n">b</span><span class="p">:[</span><span class="n">a</span><span class="p">]}</span>

<span class="n">cg</span> <span class="o">=</span> <span class="n">CandidateGraph</span><span class="o">.</span><span class="n">from_adjacency</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>

<span class="c1"># Enable the GPU</span>
<span class="n">autocnet</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Write a custom keypoint extraction function - this could get monkey patched onto the graph object...</span>
<span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">downsample_amount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">total_size</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">downsample_amount</span><span class="p">:</span>
        <span class="n">downsample_amount</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_size</span> <span class="o">/</span> <span class="mi">12500</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">downsample_amount</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">downsample_amount</span><span class="p">))</span>
    <span class="c1"># Downsample</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">imresize</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;lanczos&#39;</span><span class="p">)</span>

    <span class="n">npts</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">arr0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.5</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">PySiftData</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
    <span class="n">cs</span><span class="o">.</span><span class="n">ExtractKeypoints</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">kp</span><span class="p">,</span> <span class="n">des</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">to_data_frame</span><span class="p">()</span>
    <span class="n">kp</span> <span class="o">=</span> <span class="n">kp</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;sharpness&#39;</span><span class="p">,</span> <span class="s1">&#39;edgeness&#39;</span><span class="p">,</span> <span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;ambiguity&#39;</span><span class="p">]]</span>
    <span class="n">kp</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">kp</span><span class="p">[</span><span class="s1">&#39;ambiguity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">kp</span><span class="p">,</span> <span class="n">des</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">downsample_amount</span><span class="p">,</span> <span class="n">arr</span>

<span class="n">arr0</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geodata</span><span class="o">.</span><span class="n">read_array</span><span class="p">()</span>
<span class="n">kp0</span><span class="p">,</span> <span class="n">des0</span><span class="p">,</span> <span class="n">sd0</span><span class="p">,</span> <span class="n">downsample_amount0</span><span class="p">,</span> <span class="n">arr0</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">arr0</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">arr1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">geodata</span><span class="o">.</span><span class="n">read_array</span><span class="p">()</span>
<span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span><span class="p">,</span> <span class="n">sd1</span><span class="p">,</span> <span class="n">downsample_amount1</span><span class="p">,</span> <span class="n">arr1</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># Now apply matching, outlier detection, and compute a fundamental matrix</span>
<span class="n">sd0</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">PySiftData</span><span class="o">.</span><span class="n">from_data_frame</span><span class="p">(</span><span class="n">kp0</span><span class="p">,</span> <span class="n">des0</span><span class="p">)</span>
<span class="n">sd1</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">PySiftData</span><span class="o">.</span><span class="n">from_data_frame</span><span class="p">(</span><span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span><span class="p">)</span>

<span class="c1"># Apply the matcher</span>
<span class="n">cs</span><span class="o">.</span><span class="n">PyMatchSiftData</span><span class="p">(</span><span class="n">sd0</span><span class="p">,</span> <span class="n">sd1</span><span class="p">)</span>
<span class="n">matches</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sd0</span><span class="o">.</span><span class="n">to_data_frame</span><span class="p">()</span>
<span class="n">submatches</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;ambiguity &lt;= 0.95 and score &gt;= 0.925310&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Use the query capability to reduce the number of correspondences</span>
<span class="n">sd0</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">PySiftData</span><span class="o">.</span><span class="n">from_data_frame</span><span class="p">(</span><span class="n">kp0</span><span class="p">,</span> <span class="n">des0</span><span class="p">)</span>
<span class="n">sd1</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">PySiftData</span><span class="o">.</span><span class="n">from_data_frame</span><span class="p">(</span><span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span><span class="p">)</span>
<span class="c1"># Apply the matcher</span>
<span class="n">cs</span><span class="o">.</span><span class="n">PyMatchSiftData</span><span class="p">(</span><span class="n">sd0</span><span class="p">,</span> <span class="n">sd1</span><span class="p">)</span>

<span class="n">matches</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sd0</span><span class="o">.</span><span class="n">to_data_frame</span><span class="p">()</span>
<span class="n">submatches</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;ambiguity &lt;= 0.95 and score &gt;= 0.925310&#39;</span><span class="p">)</span>

<span class="n">kpa</span> <span class="o">=</span> <span class="n">submatches</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span>
<span class="n">kpb</span> <span class="o">=</span> <span class="n">submatches</span><span class="p">[[</span><span class="s1">&#39;match_xpos&#39;</span><span class="p">,</span> <span class="s1">&#39;match_ypos&#39;</span><span class="p">]]</span>

<span class="n">F</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">compute_fundamental_matrix</span><span class="p">(</span><span class="n">kpa</span><span class="p">,</span> <span class="n">kpb</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ransac&#39;</span><span class="p">,</span> <span class="n">reproj_threshold</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">enforce_singularity_constraint</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>

<span class="n">inliers</span> <span class="o">=</span> <span class="n">submatches</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Coupled-Decomposition">
<h2>Coupled Decomposition<a class="headerlink" href="#Coupled-Decomposition" title="Permalink to this headline">¶</a></h2>
<p>Broadly, a key problem with matching large images is the inherent
ambiguity in correspondence identifiction. As the image size increases,
so does the candidate correspondence count. The probability of finding a
correct correspondence amongst all of the erroneous correspondences then
decreases to the point where disambiguous correspondences can not be
identified. Coupled decomposition seaks to recursively partition images
into corresponding regions so that the matching problem can constrainted
to a limited number of pixels.</p>
<p>It is possible to utilize initial matches, at reduced resolution to
identify points for partioning. We demonstrate this process below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Select the correspondence nearest to the middle of the image.  We decompose into quadrants, so a mid-point is preferable for this data.</span>
<span class="n">midx</span> <span class="o">=</span> <span class="n">arr0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">midy</span> <span class="o">=</span> <span class="n">arr0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>

<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="k">import</span> <span class="n">cdist</span>
<span class="n">mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">midx</span><span class="p">,</span> <span class="n">midy</span><span class="p">]])</span>
<span class="n">dists</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">inliers</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span>
<span class="n">mid_correspondence</span> <span class="o">=</span> <span class="n">inliers</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dists</span><span class="p">)]</span>
<span class="n">mid_correspondence</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[4]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>x              5391.526855
y               127.788239
scale            10.814593
sharpness         1.617509
edgeness          4.384637
orientation     242.035156
score             0.967968
ambiguity         0.927719
match          1236.000000
match_xpos     5431.506348
match_ypos     2015.922729
match_error       0.000000
subsampling       0.000000
Name: 295, dtype: float32
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">imshow</span><span class="p">(</span><span class="n">arr0</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">inliers</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">inliers</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">arr1</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">inliers</span><span class="o">.</span><span class="n">match_xpos</span><span class="p">,</span> <span class="n">inliers</span><span class="o">.</span><span class="n">match_ypos</span><span class="p">,</span> <span class="s1">&#39;bo&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_7_0.png" src="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_7_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[5]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>[&lt;matplotlib.lines.Line2D at 0x7fde500eb1d0&gt;]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_7_2.png" src="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_7_2.png" />
</div>
</div>
<p>This is going to take a little while. The team is working on a CUDA
version that is super faster, but it is not ready yet.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Apply the decomposition algorithm</span>
<span class="kn">from</span> <span class="nn">autocnet.transformation.decompose</span> <span class="k">import</span> <span class="n">coupled_decomposition</span>
<span class="n">smembership</span><span class="p">,</span> <span class="n">dmembership</span> <span class="o">=</span> <span class="n">coupled_decomposition</span><span class="p">(</span><span class="n">arr0</span><span class="p">,</span> <span class="n">arr1</span><span class="p">,</span>
                                                 <span class="n">sorigin</span><span class="o">=</span><span class="n">mid_correspondence</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]],</span>
                                                 <span class="n">dorigin</span><span class="o">=</span><span class="n">mid_correspondence</span><span class="p">[[</span><span class="s1">&#39;match_xpos&#39;</span><span class="p">,</span> <span class="s1">&#39;match_ypos&#39;</span><span class="p">]])</span>

</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">imshow</span><span class="p">(</span><span class="n">arr0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">smembership</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">colorbar</span><span class="p">()</span>
<span class="n">show</span><span class="p">()</span>

<span class="n">imshow</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">dmembership</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_10_0.png" src="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_10_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[38]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.colorbar.Colorbar at 0x7fde177e6710&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_10_2.png" src="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_10_2.png" />
</div>
</div>
</div>
<div class="section" id="Failure-&amp;-Solution">
<h2>Failure &amp; Solution<a class="headerlink" href="#Failure-&-Solution" title="Permalink to this headline">¶</a></h2>
<p>The shear size of these images is causing the rotational invariance
method to idenfity a high level of correlation between the source image
and a pretty rotated destination image. Here we can fix that by simply
passing in a known rotation (theta in radians). We know these images are
<em>barely</em> rotated...</p>
<p>Processing is also a lot faster since we are not searching all potential
rotation angles (the default is 1/2 degree increments).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">smembership</span><span class="p">,</span> <span class="n">dmembership</span><span class="p">,</span> <span class="o">=</span> <span class="n">coupled_decomposition</span><span class="p">(</span><span class="n">arr0</span><span class="p">,</span> <span class="n">arr1</span><span class="p">,</span>
                                                 <span class="n">sorigin</span><span class="o">=</span><span class="n">mid_correspondence</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]],</span>
                                                 <span class="n">dorigin</span><span class="o">=</span><span class="n">mid_correspondence</span><span class="p">[[</span><span class="s1">&#39;match_xpos&#39;</span><span class="p">,</span> <span class="s1">&#39;match_ypos&#39;</span><span class="p">]],</span>
                                                 <span class="n">theta</span><span class="o">=-</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">imshow</span><span class="p">(</span><span class="n">arr0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">smembership</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">colorbar</span><span class="p">()</span>
<span class="n">show</span><span class="p">()</span>

<span class="n">imshow</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">dmembership</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_13_0.png" src="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_13_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[40]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.colorbar.Colorbar at 0x7fde1c066780&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_13_2.png" src="../../../_images/users_tutorials_apollopan_5a._Coupled_Decomposition_-_Part_I_13_2.png" />
</div>
</div>
<p>Now the matching problem has been reduced in size from !2500x12000
pixels to four smaller subregion.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2015 - , AutoCNetDevelopers.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../../../_sources/users/tutorials/apollopan/5a. Coupled Decomposition - Part I.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>